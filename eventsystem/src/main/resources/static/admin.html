<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Event Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; border-radius: 12px; }
        .btn-danger { margin-left: 10px; }
        .event-card ul { margin-top: 10px; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-secondary" onclick="logout()">ðŸšª Logout</button>
    </div>
    <h1 class="text-center mb-4">ðŸŽ‰ Admin Dashboard</h1>

    <div id="status" class="alert d-none"></div>

    <!-- Event Section -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="h4">Create Event</h2>
            <form id="eventForm" class="row g-2">
                <div class="col-md-6"><input type="text" id="name" class="form-control" placeholder="Event Name" required></div>
                <div class="col-md-6"><input type="text" id="description" class="form-control" placeholder="Description" required></div>
                <div class="col-md-6"><input type="datetime-local" id="date" class="form-control" required></div>
                <div class="col-md-6"><input type="text" id="venue" class="form-control" placeholder="Venue" required></div>
                <div class="col-md-6"><input type="number" id="capacity" class="form-control" placeholder="Capacity" required></div>
                <div class="col-md-6"><input type="text" id="organizer" class="form-control" placeholder="Organizer" required></div>
                <div class="col-12"><button class="btn btn-primary">Add Event</button></div>
            </form>
        </div>
    </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h3 class="h5">All Events</h3>
      <div id="eventList" class="row"></div>
    </div>
  </div>

  <!-- Registration Section (moved above students) -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h4">Event Registration</h2>
      <form id="registrationForm" class="row g-2 align-items-center">
        <div class="col-md-5">
          <select id="regStudent" class="form-select" required></select>
        </div>
        <div class="col-md-5">
          <select id="regEvent" class="form-select" required></select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-warning w-100">Register</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Student Section -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h4">Register Student</h2>
      <form id="studentForm" class="row g-2">
        <div class="col-md-4"><input type="text" id="studentId" class="form-control" placeholder="Student ID" required></div>
        <div class="col-md-4"><input type="text" id="studentName" class="form-control" placeholder="Name" required></div>
        <div class="col-md-4"><input type="email" id="studentEmail" class="form-control" placeholder="Email" required></div>
        <div class="col-12"><button class="btn btn-success">Add Student</button></div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h3 class="h5">All Students</h3>
      <div class="mb-2">
        <input id="studentSearch" class="form-control" placeholder="Search students by id, name or email">
      </div>
      <ul id="studentList" class="list-group"></ul>
    </div>
  </div>
  
  <!-- Modals -->
  <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eventDetailsModalLabel">Event Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="eventDetailsModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="studentDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="studentDetailsModalLabel">Student Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="studentDetailsModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";
    let studentsCache = [];

    // === Auth check ===
    const savedUser = localStorage.getItem("user");
    if (!savedUser) {
      window.location.href = "index.html";
    } else {
      const user = JSON.parse(savedUser);
      if (user.role !== "admin") {
        window.location.href = "student.html";
      }
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    function showMessage(msg, type = "info") {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = msg;
      statusDiv.className = `alert alert-${type}`;
      statusDiv.classList.remove("d-none");
      setTimeout(() => statusDiv.classList.add("d-none"), 4000);
    }

    // === Fetch Events ===
    async function fetchEvents() {
      const res = await fetch(`${API_BASE}/events`);
      const events = await res.json();
      const list = document.getElementById("eventList");
      const select = document.getElementById("regEvent");
      list.innerHTML = "";
      select.innerHTML = "<option value='' disabled selected>Select event</option>";

      events.forEach(ev => {
        const seatsFilled = ev.registeredStudentIds ? ev.registeredStudentIds.length : 0;
        const card = document.createElement("div");
        card.className = "col-md-6 event-card";
        card.innerHTML = `
          <div class="card border-info shadow-sm">
            <div class="card-body">
              <h5 class="card-title">${ev.name}</h5>
              <p class="card-text">
                <strong>Date:</strong> ${ev.date}<br>
                <strong>Venue:</strong> ${ev.venue}<br>
                <strong>Capacity:</strong> ${seatsFilled}/${ev.capacity}<br>
                <strong>Organizer:</strong> ${ev.organizer}
              </p>
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="mb-0"><strong>Registered:</strong> ${seatsFilled}</div>
                <div>
                  <button class="btn btn-sm btn-outline-primary me-2" onclick="exportEvent(${ev.id})">Export</button>
                  <button class="btn btn-sm btn-outline-secondary me-2" onclick="openEventDetails(${ev.id})">View</button>
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent(${ev.id})">Delete</button>
                </div>
              </div>
            </div>
          </div>
        `;
        list.appendChild(card);

        const option = document.createElement("option");
        option.value = ev.id;
        option.textContent = `${ev.id}: ${ev.name}`;
        select.appendChild(option);
      });
    }

    document.getElementById("eventForm").addEventListener("submit", async e => {
      e.preventDefault();
      const event = {
        name: document.getElementById("name").value,
        description: document.getElementById("description").value,
        date: document.getElementById("date").value,
        venue: document.getElementById("venue").value,
        capacity: parseInt(document.getElementById("capacity").value),
        organizer: document.getElementById("organizer").value
      };
      const res = await fetch(`${API_BASE}/events`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(event)
      });
      const msg = await res.text();
      showMessage(msg || "Event created!", res.ok ? "success" : "danger");
      e.target.reset();
      fetchEvents();
    });

    // === Fetch Students ===
    async function fetchStudents() {
      const res = await fetch(`${API_BASE}/students`);
      const students = await res.json();
      studentsCache = students;

      const list = document.getElementById("studentList");
      const select = document.getElementById("regStudent");
      list.innerHTML = "";
      select.innerHTML = "<option value='' disabled selected>Select student</option>";

      students.forEach(st => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `<div>${st.id}: ${st.name} (${st.email})</div>`;
        const viewBtn = document.createElement('button');
        viewBtn.className = 'btn btn-sm btn-outline-secondary me-2';
        viewBtn.textContent = 'View Details';
        viewBtn.onclick = () => openStudentDetails(st.id);
        li.appendChild(viewBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-outline-danger';
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => deleteStudent(st.id);
        li.appendChild(delBtn);
        list.appendChild(li);

        const option = document.createElement("option");
        option.value = st.id;
        option.textContent = `${st.id}: ${st.name}`;
        select.appendChild(option);
      });
    }

    document.getElementById("studentForm").addEventListener("submit", async e => {
      e.preventDefault();
      const student = {
        id: document.getElementById("studentId").value,
        name: document.getElementById("studentName").value,
        email: document.getElementById("studentEmail").value
      };
      const res = await fetch(`${API_BASE}/students`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(student)
      });
      const msg = await res.text();
      showMessage(msg || "Student added!", res.ok ? "success" : "danger");
      e.target.reset();
      fetchStudents();
    });

    // === Registration ===
    document.getElementById("registrationForm").addEventListener("submit", async e => {
      e.preventDefault();
      const studentId = document.getElementById("regStudent").value;
      const eventId = document.getElementById("regEvent").value;

      const res = await fetch(`${API_BASE}/registrations/${eventId}/${studentId}`, { method: "POST" });
      const msg = await res.text();
      showMessage(msg, res.ok ? "success" : "danger");
      fetchEvents();
    });

    // === Cancel Registration ===
    async function cancelRegistration(eventId, studentId) {
      const res = await fetch(`${API_BASE}/registrations/${eventId}/${studentId}`, { method: "DELETE" });
      const msg = await res.text();
      showMessage(msg, res.ok ? "warning" : "danger");
      fetchEvents();
    }

    // === Export Event ===
    async function exportEvent(eventId) {
      const res = await fetch(`${API_BASE}/events/${eventId}/export`);
      if (!res.ok) { showMessage(await res.text(), 'danger'); return; }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `event_${eventId}_registrations.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      showMessage('Export started', 'success');
    }

    // === Delete Event ===
    async function deleteEvent(eventId) {
      if (!confirm('Delete this event? This action cannot be undone.')) return;
      const res = await fetch(`${API_BASE}/events/${eventId}`, { method: 'DELETE' });
      if (res.ok) {
        showMessage('Event deleted', 'warning');
        fetchEvents();
      } else {
        showMessage('Failed to delete event', 'danger');
      }
    }

    // === Event Details Modal (show list and allow cancel per student) ===
    function openEventDetails(eventId) {
      fetch(`${API_BASE}/events/${eventId}`).then(r => r.json()).then(async evData => {
        const modalRoot = document.getElementById('eventDetailsModalBody');
        modalRoot.innerHTML = '';
        const title = document.getElementById('eventDetailsModalLabel');
        title.textContent = `Event: ${evData.name} (ID: ${evData.id})`;

        if (!evData.registeredStudentIds || evData.registeredStudentIds.length === 0) {
          modalRoot.innerHTML = '<p class="text-muted">No students registered.</p>';
        } else {
          const ul = document.createElement('ul'); ul.className = 'list-group';
          for (const sid of evData.registeredStudentIds) {
            const li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-center';
            const stu = studentsCache.find(s => s.id === sid);
            li.innerHTML = `<div>${stu ? stu.name + ' (' + stu.email + ')' : sid}</div>`;
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-danger';
            btn.textContent = 'Cancel Registration';
            btn.onclick = async () => {
              const res = await fetch(`${API_BASE}/registrations/${eventId}/${sid}`, { method: 'DELETE' });
              const msg = await res.text();
              showMessage(msg, res.ok ? 'warning' : 'danger');
              fetchEvents();
              // update modal content
              openEventDetails(eventId);
            };
            li.appendChild(btn);
            ul.appendChild(li);
          }
          modalRoot.appendChild(ul);
        }

        // show bootstrap modal (simple)
        const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
        modal.show();
      }).catch(e => showMessage('Failed to load event details', 'danger'));
    }

    // === Delete Student ===
    async function deleteStudent(studentId) {
      if (!confirm('Delete this student? This action cannot be undone.')) return;
      const res = await fetch(`${API_BASE}/students/${encodeURIComponent(studentId)}`, { method: 'DELETE' });
      if (res.ok) {
        showMessage('Student deleted', 'warning');
        fetchStudents();
        fetchEvents();
      } else {
        showMessage('Failed to delete student', 'danger');
      }
    }

    // === Student search/filter ===
    document.getElementById('studentSearch').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase().trim();
      const list = document.getElementById('studentList');
      list.innerHTML = '';
      const filtered = studentsCache.filter(s => (
        s.id.toLowerCase().includes(q) || (s.name && s.name.toLowerCase().includes(q)) || (s.email && s.email.toLowerCase().includes(q))
      ));
      filtered.forEach(st => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<div>${st.id}: ${st.name} (${st.email})</div>`;
  const viewBtn = document.createElement('button');
  viewBtn.className = 'btn btn-sm btn-outline-secondary me-2';
  viewBtn.textContent = 'View Details';
  viewBtn.onclick = () => openStudentDetails(st.id);
  li.appendChild(viewBtn);

  const delBtn = document.createElement('button');
  delBtn.className = 'btn btn-sm btn-outline-danger';
  delBtn.textContent = 'Delete';
  delBtn.onclick = () => deleteStudent(st.id);
  li.appendChild(delBtn);
        list.appendChild(li);
      });
    });

    // Open student details modal (shows events they're registered for and allow cancel per event)
    function openStudentDetails(studentId) {
      const student = studentsCache.find(s => s.id === studentId);
      if (!student) { showMessage('Student not found', 'danger'); return; }
      document.getElementById('studentDetailsModalLabel').textContent = `${student.id}: ${student.name}`;
      const body = document.getElementById('studentDetailsModalBody');
      body.innerHTML = '<p>Loading...</p>';
      fetch(`${API_BASE}/events`).then(r => r.json()).then(events => {
        const registered = events.filter(ev => (ev.registeredStudentIds || []).includes(studentId));
        if (registered.length === 0) {
          body.innerHTML = '<p class="text-muted">This student is not registered for any events.</p>';
        } else {
          const ul = document.createElement('ul'); ul.className = 'list-group';
          registered.forEach(ev => {
            const li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `<div>${ev.name} (ID: ${ev.id})</div>`;
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-danger';
            btn.textContent = 'Cancel Registration';
            btn.onclick = async () => {
              const res = await fetch(`${API_BASE}/registrations/${ev.id}/${studentId}`, { method: 'DELETE' });
              const msg = await res.text();
              showMessage(msg, res.ok ? 'warning' : 'danger');
              fetchEvents();
              openStudentDetails(studentId);
            };
            li.appendChild(btn);
            ul.appendChild(li);
          });
          body.innerHTML = '';
          body.appendChild(ul);
        }
        const modal = new bootstrap.Modal(document.getElementById('studentDetailsModal'));
        modal.show();
      });
    }

    // update fetchStudents to render 'View Details' buttons for each student
    const origFetchStudents = fetchStudents;
    fetchStudents = async function() {
      const res = await fetch(`${API_BASE}/students`);
      const students = await res.json();
      studentsCache = students;

      const list = document.getElementById("studentList");
      const select = document.getElementById("regStudent");
      list.innerHTML = "";
      select.innerHTML = "<option value='' disabled selected>Select student</option>";

        students.forEach(st => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<div>${st.id}: ${st.name} (${st.email})</div>`;
          const viewBtn = document.createElement('button');
          viewBtn.className = 'btn btn-sm btn-outline-secondary me-2';
          viewBtn.textContent = 'View Details';
          viewBtn.onclick = () => openStudentDetails(st.id);
          li.appendChild(viewBtn);

          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-sm btn-outline-danger';
          delBtn.textContent = 'Delete';
          delBtn.onclick = () => deleteStudent(st.id);
          li.appendChild(delBtn);

          list.appendChild(li);

        const option = document.createElement("option");
        option.value = st.id;
        option.textContent = `${st.id}: ${st.name}`;
        select.appendChild(option);
      });
    };



    // Initial load
    fetchStudents().then(fetchEvents);
</script>
</body>
</html>
