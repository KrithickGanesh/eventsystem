<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard - Event Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-bottom: 20px; border-radius: 12px; }
        .btn-danger { margin-left: 10px; }
        .event-card ul { margin-top: 10px; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-secondary" onclick="logout()">üö™ Logout</button>
    </div>
    <h1 class="text-center mb-4">üéâ Admin Dashboard</h1>

    <div id="status" class="alert d-none"></div>

    <!-- Event Section -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="h4">Create Event</h2>
            <form id="eventForm" class="row g-2">
                <div class="col-md-6"><input type="text" id="name" class="form-control" placeholder="Event Name" required></div>
                <div class="col-md-6"><input type="text" id="description" class="form-control" placeholder="Description" required></div>
                <div class="col-md-6"><input type="datetime-local" id="date" class="form-control" required></div>
                <div class="col-md-6"><input type="text" id="venue" class="form-control" placeholder="Venue" required></div>
                <div class="col-md-6"><input type="number" id="capacity" class="form-control" placeholder="Capacity" required></div>
                <div class="col-md-6"><input type="text" id="organizer" class="form-control" placeholder="Organizer" required></div>
                <div class="col-12"><button class="btn btn-primary">Add Event</button></div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h3 class="h5">All Events</h3>
            <div id="eventList" class="row"></div>
        </div>
    </div>

    <!-- Student Section -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="h4">Register Student</h2>
            <form id="studentForm" class="row g-2">
                <div class="col-md-4"><input type="text" id="studentId" class="form-control" placeholder="Student ID" required></div>
                <div class="col-md-4"><input type="text" id="studentName" class="form-control" placeholder="Name" required></div>
                <div class="col-md-4"><input type="email" id="studentEmail" class="form-control" placeholder="Email" required></div>
                <div class="col-12"><button class="btn btn-success">Add Student</button></div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h3 class="h5">All Students</h3>
            <ul id="studentList" class="list-group"></ul>
        </div>
    </div>

    <!-- Registration Section -->
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="h4">Event Registration</h2>
            <form id="registrationForm" class="row g-2 align-items-center">
                <div class="col-md-5">
                    <select id="regStudent" class="form-select" required></select>
                </div>
                <div class="col-md-5">
                    <select id="regEvent" class="form-select" required></select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-warning w-100">Register</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";
    let studentsCache = [];

    // === Auth check ===
    const savedUser = localStorage.getItem("user");
    if (!savedUser) {
      window.location.href = "login.html";
    } else {
      const user = JSON.parse(savedUser);
      if (user.role !== "admin") {
        window.location.href = "student.html";
      }
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    function showMessage(msg, type = "info") {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = msg;
      statusDiv.className = `alert alert-${type}`;
      statusDiv.classList.remove("d-none");
      setTimeout(() => statusDiv.classList.add("d-none"), 4000);
    }

    // === Fetch Events ===
    async function fetchEvents() {
      const res = await fetch(`${API_BASE}/events`);
      const events = await res.json();
      const list = document.getElementById("eventList");
      const select = document.getElementById("regEvent");
      list.innerHTML = "";
      select.innerHTML = "<option value='' disabled selected>Select event</option>";

      events.forEach(ev => {
        const seatsFilled = ev.registeredStudentIds ? ev.registeredStudentIds.length : 0;
        const card = document.createElement("div");
        card.className = "col-md-6 event-card";
        card.innerHTML = `
          <div class="card border-info shadow-sm">
            <div class="card-body">
              <h5 class="card-title">${ev.name}</h5>
              <p class="card-text">
                <strong>Date:</strong> ${ev.date}<br>
                <strong>Venue:</strong> ${ev.venue}<br>
                <strong>Capacity:</strong> ${seatsFilled}/${ev.capacity}<br>
                <strong>Organizer:</strong> ${ev.organizer}
              </p>
              <h6>Registered Students:</h6>
              <ul class="list-group list-group-flush">
                ${ev.registeredStudentIds && ev.registeredStudentIds.length > 0 ?
                  ev.registeredStudentIds.map(sid => {
                    const stu = studentsCache.find(s => s.id === sid);
                    return `<li class="list-group-item">
                              üë§ ${stu ? stu.name + " (" + stu.email + ")" : sid}
                              <button class="btn btn-sm btn-danger float-end"
                                onclick="cancelRegistration(${ev.id}, '${sid}')">‚ùå Cancel</button>
                            </li>`;
                  }).join("") :
                  "<li class='list-group-item text-muted'>No students registered yet.</li>"
                }
              </ul>
            </div>
          </div>
        `;
        list.appendChild(card);

        const option = document.createElement("option");
        option.value = ev.id;
        option.textContent = `${ev.id}: ${ev.name}`;
        select.appendChild(option);
      });
    }

    document.getElementById("eventForm").addEventListener("submit", async e => {
      e.preventDefault();
      const event = {
        name: document.getElementById("name").value,
        description: document.getElementById("description").value,
        date: document.getElementById("date").value,
        venue: document.getElementById("venue").value,
        capacity: parseInt(document.getElementById("capacity").value),
        organizer: document.getElementById("organizer").value
      };
      const res = await fetch(`${API_BASE}/events`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(event)
      });
      const msg = await res.text();
      showMessage(msg || "Event created!", res.ok ? "success" : "danger");
      e.target.reset();
      fetchEvents();
    });

    // === Fetch Students ===
    async function fetchStudents() {
      const res = await fetch(`${API_BASE}/students`);
      const students = await res.json();
      studentsCache = students;

      const list = document.getElementById("studentList");
      const select = document.getElementById("regStudent");
      list.innerHTML = "";
      select.innerHTML = "<option value='' disabled selected>Select student</option>";

      students.forEach(st => {
        const li = document.createElement("li");
        li.className = "list-group-item";
        li.textContent = `${st.id}: ${st.name} (${st.email})`;
        list.appendChild(li);

        const option = document.createElement("option");
        option.value = st.id;
        option.textContent = `${st.id}: ${st.name}`;
        select.appendChild(option);
      });
    }

    document.getElementById("studentForm").addEventListener("submit", async e => {
      e.preventDefault();
      const student = {
        id: document.getElementById("studentId").value,
        name: document.getElementById("studentName").value,
        email: document.getElementById("studentEmail").value
      };
      const res = await fetch(`${API_BASE}/students`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(student)
      });
      const msg = await res.text();
      showMessage(msg || "Student added!", res.ok ? "success" : "danger");
      e.target.reset();
      fetchStudents();
    });

    // === Registration ===
    document.getElementById("registrationForm").addEventListener("submit", async e => {
      e.preventDefault();
      const studentId = document.getElementById("regStudent").value;
      const eventId = document.getElementById("regEvent").value;

      const res = await fetch(`${API_BASE}/registrations/${eventId}/${studentId}`, { method: "POST" });
      const msg = await res.text();
      showMessage(msg, res.ok ? "success" : "danger");
      fetchEvents();
    });

    // === Cancel Registration ===
    async function cancelRegistration(eventId, studentId) {
      const res = await fetch(`${API_BASE}/registrations/${eventId}/${studentId}`, { method: "DELETE" });
      const msg = await res.text();
      showMessage(msg, res.ok ? "warning" : "danger");
      fetchEvents();
    }

    // Initial load
    fetchStudents().then(fetchEvents);
</script>
</body>
</html>
