<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 12px; margin-bottom: 20px; }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-secondary" onclick="logout()">ğŸšª Logout</button>
    </div>
    <h1 class="text-center mb-4">ğŸ“ Student Dashboard</h1>
    <h5 id="welcome"></h5>

    <div id="status" class="alert d-none"></div>

    <div class="card shadow-sm">
        <div class="card-body">
            <h3 class="h5">Available Events</h3>
            <div id="eventList" class="row"></div>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";

    // === Auth check ===
    const savedUser = localStorage.getItem("user");
    if (!savedUser) {
      window.location.href = "login.html";
    }
    const user = JSON.parse(savedUser);
    if (user.role !== "student") {
      window.location.href = "admin.html";
    }

    const studentId = user.id;
    const email = user.email;

    // Show student's name in greeting. Prefer name stored in localStorage user object,
    // otherwise fetch the student by id to get the name.
    async function setWelcome() {
      let name = user.name;
      if (!name) {
        try {
          const r = await fetch(`${API_BASE}/students/${studentId}`);
          if (r.ok) {
            const data = await r.json();
            name = data.name;
          }
        } catch (e) {
          // ignore and fall back to id
        }
      }
      // Title-case the name if present (Prakash instead of prakash)
      function titleCase(s) {
        return s.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
      }
      const displayName = name ? titleCase(name) : studentId;
      document.getElementById("welcome").textContent = `Welcome, ${displayName}`;
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "login.html";
    }

    function showMessage(msg, type = "info") {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = msg;
      statusDiv.className = `alert alert-${type}`;
      statusDiv.classList.remove("d-none");
      setTimeout(() => statusDiv.classList.add("d-none"), 4000);
    }

    async function fetchEvents() {
      const res = await fetch(`${API_BASE}/events`);
      const events = await res.json();
      const list = document.getElementById("eventList");
      list.innerHTML = "";

      events.forEach(ev => {
        const seatsFilled = ev.registeredStudentIds ? ev.registeredStudentIds.length : 0;
        const isRegistered = ev.registeredStudentIds && ev.registeredStudentIds.includes(studentId);

        const card = document.createElement("div");
        card.className = "col-md-6";
        card.innerHTML = `
          <div class="card border-info shadow-sm">
            <div class="card-body">
              <h5 class="card-title">${ev.name}</h5>
              <p class="card-text">
                <strong>Date:</strong> ${ev.date}<br>
                <strong>Venue:</strong> ${ev.venue}<br>
                <strong>Capacity:</strong> ${seatsFilled}/${ev.capacity}<br>
                <strong>Organizer:</strong> ${ev.organizer}
              </p>
              <button class="btn ${isRegistered ? "btn-danger" : "btn-success"}"
                      onclick="${isRegistered ?
                        `cancelRegistration(${ev.id}, '${studentId}')` :
                        `registerStudent(${ev.id}, '${studentId}')`}">
                ${isRegistered ? "âŒ Cancel Registration" : "âœ… Register"}
              </button>
            </div>
          </div>
        `;
        list.appendChild(card);
      });
    }

    async function registerStudent(eventId, studentId) {
      const res = await fetch(`${API_BASE}/registrations/${eventId}/${studentId}`, { method: "POST" });
      const text = await res.text();
      showMessage(text, res.ok ? "success" : "danger");
      fetchEvents();
    }

    async function cancelRegistration(eventId, studentId) {
      const res = await fetch(`${API_BASE}/registrations/${eventId}/${studentId}`, { method: "DELETE" });
      const text = await res.text();
      showMessage(text, res.ok ? "warning" : "danger");
      fetchEvents();
    }

  // Ensure welcome is set before loading events so greeting appears immediately
  setWelcome().then(() => fetchEvents());
</script>
</body>
</html>
