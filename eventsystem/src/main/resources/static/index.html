<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login - Event Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .login-card { max-width: 400px; margin: 80px auto; border-radius: 12px; }
    </style>
</head>
<body>
<div class="container">
    <div class="card login-card shadow">
        <div class="card-body">
            <h2 class="text-center mb-4">üîê Login</h2>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="userId" class="form-label">User ID</label>
                    <input type="text" class="form-control" id="userId" required placeholder="e.g. admin or S001">
                </div>
                <div class="mb-3" id="adminPasswordField" style="display:none;">
                    <label for="password" class="form-label">Password (admin only)</label>
                    <input type="password" class="form-control" id="password" placeholder="Enter admin password">
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Email (for students only)</label>
                    <input type="email" class="form-control" id="email" placeholder="student@example.com">
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
            <p class="text-muted small mt-3">
                Use <b>admin</b> + password for organizer login.<br>
                Students: enter Student ID + Email.
            </p>
            <div id="status" class="alert d-none mt-3"></div>
        </div>
    </div>
</div>

<script>
  const ADMIN_PASSWORD = "Admin420";
  const API_BASE = "http://localhost:8080/api";

    // Auto redirect if already logged in
    const savedUser = localStorage.getItem("user");
    if (savedUser) {
      const user = JSON.parse(savedUser);
      if (user.role === "admin") {
        window.location.href = "admin.html";
      } else {
        window.location.href = "student.html";
      }
    }

    // Show/hide password field if "admin" typed
    document.getElementById("userId").addEventListener("input", function() {
      if (this.value.trim().toLowerCase() === "admin") {
        document.getElementById("adminPasswordField").style.display = "block";
      } else {
        document.getElementById("adminPasswordField").style.display = "none";
      }
    });

    function showMessage(msg, type = "danger") {
      const statusDiv = document.getElementById("status");
      statusDiv.textContent = msg;
      statusDiv.className = `alert alert-${type}`;
      statusDiv.classList.remove("d-none");
      setTimeout(() => statusDiv.classList.add("d-none"), 4000);
    }

  document.getElementById("loginForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const userId = document.getElementById("userId").value.trim();
      const password = document.getElementById("password").value.trim();
      const email = document.getElementById("email").value.trim();

      let userData;
      if (userId.toLowerCase() === "admin") {
        if (password !== ADMIN_PASSWORD) {
          showMessage("‚ùå Invalid admin password", "danger");
          return;
        }
        userData = { role: "admin", id: "admin" };
        localStorage.setItem("user", JSON.stringify(userData));
        window.location.href = "admin.html";
      } else {
        if (!email) {
          showMessage("‚ùå Students must enter email", "danger");
          return;
        }
        // Validate student exists and email matches
        try {
          const res = await fetch(`${API_BASE}/students/${encodeURIComponent(userId)}`);
          if (!res.ok) {
            showMessage("Student not found", "danger");
            return;
          }
          const student = await res.json();
          if (!student.email || student.email.toLowerCase() !== email.toLowerCase()) {
            showMessage("Student not found", "danger");
            return;
          }
          // Valid student ‚Äî store user info (include name if present)
          const userData = { role: "student", id: student.id, email: student.email, name: student.name };
          localStorage.setItem("user", JSON.stringify(userData));
          window.location.href = "student.html";
        } catch (err) {
          showMessage("‚ùå Failed to validate student. Try again.", "danger");
          return;
        }
      }
    });
</script>
</body>
</html>
